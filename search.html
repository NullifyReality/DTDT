<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2790699901602858" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Search - Do They Drug Test?</title>
    <meta property="og:type" content="website">
    <meta name="description" content="Search for company drug testing policies">
    <meta property="og:image" content="https://dotheydrugtest.com/assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1280" href="assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1197" href="assets/img/Radicaltube.png" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/animate.min.min.css">
    <style>
        .company-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 10px;
        }
        .test-yes { color: #d9534f; font-weight: bold; }
        .test-no { color: #5cb85c; font-weight: bold; }
        .test-sometimes { color: #f0ad4e; font-weight: bold; }
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page-btn {
            margin: 0 5px;
            padding: 5px 15px;
        }
        .results-info {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body id="page-top" data-bs-spy="scroll" data-bs-target="#mainNav" data-bs-offset="77">
    <nav class="navbar navbar-expand-md fixed-top mb-0 pb-0" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">Do They Drug Test?</a>
            <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navbarResponsive" type="button" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" value="Menu" style="padding: 5px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-stack" style="font-size: 21px;">
                    <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.598.598 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535L7.733.063z"></path>
                    <path d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.598.598 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.659z"></path>
                </svg>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item nav-link"></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="/donations.html" style="color: var(--bs-light);">support the cause &lt;3</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="text-center content-section" id="search" style="background: #080808; padding: 100px 0px 20px;">
        <div class="container">
            <!-- Remove the warning alert since site is now working -->
            <div class="alert alert-info beautiful" role="alert" id="api-status">
                <strong>Live Search Active!</strong> Database updated daily with new companies.
            </div>

            <section class="mt-4 pt-0 py-5">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <input class="form-control-lg mb-3" type="search" id="Search-Bar-1" placeholder="Search company names or industries..." autofocus style="background: rgba(163,163,163,0.96); border-radius: 14px; border: 3px solid var(--bs-black); text-align: center;">
                        
                        <div class="d-flex justify-content-center mb-4">
                            <button class="btn btn-primary me-2" id="open-filters" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-menu" style="border-radius: 4px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
                                </svg> Filters
                            </button>
                            <button class="btn btn-success ms-2" id="StartSearch" type="button" style="font-size: 18px; border-radius: 4px;">
                                Search
                            </button>
                        </div>

                        <!-- Loading Spinner -->
                        <div class="loading-spinner" id="loadingSpinner"></div>

                        <!-- Results Info -->
                        <div class="results-info" id="resultsInfo" style="display: none;">
                            Found <span id="resultsCount">0</span> companies
                            <span id="pageInfo" class="float-end">Page 1</span>
                        </div>

                        <!-- Results Container -->
                        <div id="resultsContainer"></div>

                        <!-- Pagination -->
                        <div class="mt-4" id="pagination" style="display: none;">
                            <button class="btn btn-outline-primary page-btn" id="prevPage" disabled>Previous</button>
                            <span class="mx-3">Page <span id="currentPage">1</span></span>
                            <button class="btn btn-outline-primary page-btn" id="nextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <!-- Filters Offcanvas -->
    <div class="offcanvas offcanvas-start bg-body" tabindex="-1" id="offcanvas-menu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-funnel-fill me-2" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                </svg>
                Search Filters
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label class="form-label"><strong>Do they test?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="tests_required" id="tests_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="tests_no">No</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Random tests?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="random_tests" id="random_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="random_no">No</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>After accident?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="after_accident" id="accident_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="accident_no">No</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>During hiring?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="hiring_no">No</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="hiring_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_any" autocomplete="off">
                    <label class="btn btn btn-outline-primary" for="hiring_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Filter by state</strong></label>
                <select class="form-select" id="stateFilter">
                    <option value="">All States</option>
                    <option value="CA">California</option>
                    <option value="TX">Texas</option>
                    <option value="NY">New York</option>
                    <option value="FL">Florida</option>
                    <option value="WA">Washington</option>
                    <option value="IL">Illinois</option>
                    <option value="GA">Georgia</option>
                    <option value="NC">North Carolina</option>
                    <option value="MA">Massachusetts</option>
                    <option value="CO">Colorado</option>
                    <option value="AZ">Arizona</option>
                    <option value="NV">Nevada</option>
                    <option value="OH">Ohio</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="MI">Michigan</option>
                </select>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary w-100 mb-2" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p>Copyright © Do They Drug Test? 2025</p>
        </div>
    </footer>

    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    
    // Add this script at the end of your search.html body, right before </body>
<script>
    // API Configuration
    const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000' 
        : 'https://api.dotheydrugtest.com';
    
    // State management
    let currentPage = 1;
    let currentQuery = '';
    let currentFilters = {};
    let totalResults = 0;
    let hasNextPage = false;

    // DOM Elements
    const searchInput = document.getElementById('Search-Bar-1');
    const searchButton = document.getElementById('StartSearch');
    const resultsContainer = document.getElementById('resultsContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsInfo = document.getElementById('resultsInfo');
    const resultsCount = document.getElementById('resultsCount');
    const pageInfo = document.getElementById('pageInfo');
    const pagination = document.getElementById('pagination');
    const currentPageSpan = document.getElementById('currentPage');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    
    // Initialize results container if it doesn't exist
    if (!resultsContainer) {
        const newContainer = document.createElement('div');
        newContainer.id = 'resultsContainer';
        newContainer.className = 'mt-4';
        // Insert after the search section
        const searchSection = document.querySelector('section');
        if (searchSection) {
            searchSection.appendChild(newContainer);
        }
    }

    // Initialize from URL parameters
    function initFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        
        if (query !== null) {  // Allow empty string!
            searchInput.value = query;
            currentQuery = query;
            setTimeout(() => performSearch(1), 100);
        } else {
            // No query in URL - user can still search with filters only
            setTimeout(() => performSearch(1), 100);
        }
    }

    // Perform search with ALL filters
    async function performSearch(page = 1) {
        currentPage = page;
        
        // Get current query (can be empty string!)
        currentQuery = searchInput ? searchInput.value.trim() : '';
        
        // Build filters object
        const filters = {
            q: currentQuery,  // Can be empty string!
            page: page
        };
        
        // Get filter values from UI
        try {
            // Boolean filters (Yes/No/Any)
            const testsFilter = document.querySelector('input[name="tests_required"]:checked');
            if (testsFilter && testsFilter.id !== 'tests_any') {
                filters.tests_required = testsFilter.id === 'tests_yes';
            }
            
            const randomFilter = document.querySelector('input[name="random_tests"]:checked');
            if (randomFilter && randomFilter.id !== 'random_any') {
                filters.random_tests = randomFilter.id === 'random_yes';
            }
            
            const accidentFilter = document.querySelector('input[name="after_accident"]:checked');
            if (accidentFilter && accidentFilter.id !== 'accident_any') {
                filters.after_accident = accidentFilter.id === 'accident_yes';
            }
            
            const hiringFilter = document.querySelector('input[name="during_hiring"]:checked');
            if (hiringFilter && hiringFilter.id !== 'hiring_any') {
                filters.during_hiring = hiringFilter.id === 'hiring_yes';
            }
            
            // Location filter
            const stateSelect = document.getElementById('stateFilter');
            if (stateSelect && stateSelect.value) {
                filters.location = stateSelect.value;
            }
        } catch (e) {
            console.log('Filters not yet available in DOM');
        }
        
        currentFilters = filters;
        
        // Show loading
        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (resultsInfo) resultsInfo.style.display = 'none';
        if (pagination) pagination.style.display = 'none';
        
        try {
            // Build URL with filters
            const url = new URL(`${API_BASE}/api/search`);
            Object.keys(filters).forEach(key => {
                // IMPORTANT: Send empty string for blank search, not undefined
                const value = filters[key];
                if (value !== undefined && value !== null) {
                    url.searchParams.append(key, value);
                }
            });
            
            console.log('Fetching:', url.toString());
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update state
            totalResults = data.total || data.results.length;
            hasNextPage = data.has_next || false;
            
            // Display results
            displayResults(data.results, data.grouped_results);
            
            // Update UI
            if (resultsCount) resultsCount.textContent = totalResults;
            if (pageInfo) pageInfo.textContent = `Page ${page}`;
            if (currentPageSpan) currentPageSpan.textContent = page;
            
            // Update pagination buttons
            if (prevPageBtn) prevPageBtn.disabled = page === 1;
            if (nextPageBtn) nextPageBtn.disabled = !hasNextPage;
            
            // Show UI elements
            if (resultsInfo) resultsInfo.style.display = 'block';
            if (pagination) pagination.style.display = 'flex';
            
            // Update URL without reload (except for empty query)
            if (currentQuery !== '') {
                const url = new URL(window.location);
                url.searchParams.set('q', currentQuery);
                window.history.pushState({}, '', url);
            }
            
        } catch (error) {
            console.error('Search error:', error);
            if (resultsContainer) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Search failed:</strong> ${error.message}<br>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="retrySearch()">Retry</button>
                        <button class="btn btn-sm btn-outline-warning mt-2 ms-2" onclick="resetFilters()">Reset Filters</button>
                    </div>
                `;
            }
        } finally {
            if (loadingSpinner) loadingSpinner.style.display = 'none';
        }
    }

    // Display results with grouping
    function displayResults(companies, groupedResults = null) {
        if (!resultsContainer) return;
        
        if (!companies || companies.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning">
                    No companies found matching your criteria.
                    <button class="btn btn-sm btn-outline-warning ms-2" onclick="resetFilters()">Reset Filters</button>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        // If we have grouped results, display with sections
        if (groupedResults && (groupedResults.exact_matches.length > 0 || groupedResults.industry_matches.length > 0)) {
            // Exact matches section
            if (groupedResults.exact_matches.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-success">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                            </svg>
                            Exact Matches (${groupedResults.exact_matches.length})
                        </h4>
                        ${createCompaniesAccordion(groupedResults.exact_matches, 'exact')}
                    </div>
                `;
            }
            
            // Industry matches section
            if (groupedResults.industry_matches.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-building me-2" viewBox="0 0 16 16">
                                <path d="M4 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM7.5 5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM4.5 8a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Z"/>
                                <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V1Zm11 0H3v14h3v-2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V15h3V1Z"/>
                            </svg>
                            Related Companies in Same Industry (${groupedResults.industry_matches.length})
                        </h4>
                        ${createCompaniesAccordion(groupedResults.industry_matches, 'industry')}
                    </div>
                `;
            }
            
            // Other matches section
            if (groupedResults.other_matches && groupedResults.other_matches.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                            Other Relevant Companies (${groupedResults.other_matches.length})
                        </h4>
                        ${createCompaniesAccordion(groupedResults.other_matches, 'other')}
                    </div>
                `;
            }
            
            // Total summary
            html += `
                <div class="alert alert-info mt-4">
                    <strong>${companies.length} companies found</strong>
                    <span class="float-end">
                        ${groupedResults.exact_matches.length} exact • 
                        ${groupedResults.industry_matches.length} industry •
                        ${groupedResults.other_matches ? groupedResults.other_matches.length : 0} other
                    </span>
                </div>
            `;
            
        } else {
            // No grouping, show all
            html = createCompaniesAccordion(companies, 'all');
        }
        
        resultsContainer.innerHTML = html;
        
        // Initialize Bootstrap accordions
        const accordions = resultsContainer.querySelectorAll('.accordion-button');
        accordions.forEach(button => {
            button.addEventListener('click', function() {
                this.classList.toggle('collapsed');
            });
        });
    }

    // Helper: Create accordion HTML
    function createCompaniesAccordion(companies, sectionId) {
        if (!companies || companies.length === 0) return '';
        
        let html = `<div class="accordion" id="accordion-${sectionId}">`;
        
        companies.forEach((company, index) => {
            const accordionItemId = `${sectionId}-${index}`;
            const collapseId = `collapse-${accordionItemId}`;
            
            // Determine badge
            const badgeInfo = getTestingBadge(company);
            
            // Build policy summary
            const policies = getPolicySummary(company);
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div>
                                    <strong>${company.name}</strong>
                                    <span class="badge ${badgeInfo.color} company-badge ms-2">${badgeInfo.text}</span>
                                    ${company.industry ? `<span class="badge bg-info company-badge ms-1">${company.industry}</span>` : ''}
                                </div>
                                <small class="text-muted">${policies.summary}</small>
                            </div>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordion-${sectionId}">
                        <div class="accordion-body">
                            ${createCompanyDetailsHTML(company, policies)}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }

    // Helper: Get testing badge
    function getTestingBadge(company) {
        if (!company.tests_required && !company.random_tests && 
            !company.after_accident && !company.during_hiring) {
            return { color: 'bg-success', text: 'No Tests' };
        } else if (company.tests_required || company.random_tests) {
            return { color: 'bg-danger', text: 'Regular Tests' };
        } else if (company.during_hiring) {
            return { color: 'bg-warning', text: 'Hiring Test' };
        } else {
            return { color: 'bg-secondary', text: 'Check Details' };
        }
    }

    // Helper: Get policy summary
    function getPolicySummary(company) {
        const policies = [];
        if (company.tests_required) policies.push('Testing Required');
        if (company.random_tests) policies.push('Random Tests');
        if (company.after_accident) policies.push('Post-Accident');
        if (company.during_hiring) policies.push('Pre-Employment');
        
        const summary = policies.length > 0 ? policies.join(' • ') : 'No Testing Policy';
        const details = policies.length > 0 ? policies.join(', ') : 'No drug testing requirements';
        
        return { summary, details };
    }

    // Helper: Create company details HTML
    function createCompanyDetailsHTML(company, policies) {
        return `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Industry:</strong> ${company.industry || 'Not specified'}</p>
                    ${company.description ? `<p><strong>Description:</strong> ${company.description}</p>` : ''}
                    <p><strong>Testing Policy:</strong> ${policies.details}</p>
                    ${company.test_type ? `<p><strong>Test Type:</strong> ${company.test_type}</p>` : ''}
                    ${company.test_frequency ? `<p><strong>Frequency:</strong> ${company.test_frequency}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Testing Details:</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>Tests Required:</td>
                            <td><span class="${company.tests_required ? 'test-yes' : 'test-no'}">${company.tests_required ? 'YES' : 'NO'}</span></td>
                        </tr>
                        <tr>
                            <td>Random Tests:</td>
                            <td><span class="${company.random_tests ? 'test-yes' : 'test-no'}">${company.random_tests ? 'YES' : 'NO'}</span></td>
                        </tr>
                        <tr>
                            <td>After Accident:</td>
                            <td><span class="${company.after_accident ? 'test-yes' : 'test-no'}">${company.after_accident ? 'YES' : 'NO'}</span></td>
                        </tr>
                        <tr>
                            <td>During Hiring:</td>
                            <td><span class="${company.during_hiring ? 'test-yes' : 'test-no'}">${company.during_hiring ? 'YES' : 'NO'}</span></td>
                        </tr>
                    </table>
                    ${company.states && Array.isArray(company.states) && company.states.length > 0 && company.states[0] ? 
                        `<p><strong>Operates in:</strong> ${company.states.filter(s => s).join(', ')}</p>` : ''}
                </div>
            </div>
            ${company.policy_details ? `
                <div class="mt-3 p-2 bg-light rounded">
                    <small><strong>Additional Notes:</strong> ${company.policy_details}</small>
                </div>
            ` : ''}
        `;
    }

    // Filter functions
    function applyFilters() {
        const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvas-menu'));
        if (offcanvas) offcanvas.hide();
        performSearch(1);
    }

    function resetFilters() {
        // Reset all radio buttons to "Any"
        const anyRadios = document.querySelectorAll('input[type="radio"][id$="_any"]');
        anyRadios.forEach(radio => radio.checked = true);
        
        // Reset state filter
        const stateSelect = document.getElementById('stateFilter');
        if (stateSelect) stateSelect.value = '';
        
        performSearch(1);
    }

    function retrySearch() {
        performSearch(currentPage);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize search
        initFromURL();
        
        // Search button
        if (searchButton) {
            searchButton.addEventListener('click', () => {
                performSearch(1);
            });
        }
        
        // Search input enter key
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(1);
                }
            });
        }
        
        // Pagination buttons
        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    performSearch(currentPage - 1);
                }
            });
        }
        
        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', () => {
                if (hasNextPage) {
                    performSearch(currentPage + 1);
                }
            });
        }
        
        // Test API connection
        fetch(`${API_BASE}/`)
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('api-status');
                if (statusElement) {
                    statusElement.innerHTML = 
                        `<strong>API Connected!</strong> Ready to search ${data.message}`;
                }
            })
            .catch(error => {
                console.log('API test failed:', error);
            });
    });

    // Make functions globally available
    window.performSearch = performSearch;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.retrySearch = retrySearch;
</script>
</body>
</html>
