<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2790699901602858" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Search - Do They Drug Test?</title>
    <meta property="og:type" content="website">
    <meta name="description" content="Search for company drug testing policies">
    <meta property="og:image" content="https://dotheydrugtest.com/assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1280" href="assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1197" href="assets/img/Radicaltube.png" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/animate.min.min.css">
    <style>
        .company-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 10px;
        }
        .test-yes { color: #d9534f; font-weight: bold; }
        .test-no { color: #5cb85c; font-weight: bold; }
        .test-sometimes { color: #f0ad4e; font-weight: bold; }
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page-btn {
            margin: 0 5px;
            padding: 5px 15px;
        }
        .results-info {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body id="page-top" data-bs-spy="scroll" data-bs-target="#mainNav" data-bs-offset="77">
    <nav class="navbar navbar-expand-md fixed-top mb-0 pb-0" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">Do They Drug Test?</a>
            <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navbarResponsive" type="button" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" value="Menu" style="padding: 5px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-stack" style="font-size: 21px;">
                    <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.598.598 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535L7.733.063z"></path>
                    <path d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.598.598 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.659z"></path>
                </svg>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item nav-link"></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="/donations.html" style="color: var(--bs-light);">support the cause &lt;3</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="text-center content-section" id="search" style="background: #080808; padding: 100px 0px 20px;">
        <div class="container">
            <!-- Remove the warning alert since site is now working -->
            <div class="alert alert-info beautiful" role="alert" id="api-status">
                <strong>Live Search Active!</strong> Database updated daily with new companies.
            </div>

            <section class="mt-4 pt-0 py-5">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <input class="form-control-lg mb-3" type="search" id="Search-Bar-1" placeholder="Search company names or industries..." autofocus style="background: rgba(163,163,163,0.96); border-radius: 14px; border: 3px solid var(--bs-black); text-align: center;">
                        
                        <div class="d-flex justify-content-center mb-4">
                            <button class="btn btn-primary me-2" id="open-filters" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-menu" style="border-radius: 4px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
                                </svg> Filters
                            </button>
                            <button class="btn btn-success ms-2" id="StartSearch" type="button" style="font-size: 18px; border-radius: 4px;">
                                Search
                            </button>
                        </div>

                        <!-- Loading Spinner -->
                        <div class="loading-spinner" id="loadingSpinner"></div>

                        <!-- Results Info -->
                        <div class="results-info" id="resultsInfo" style="display: none;">
                            Found <span id="resultsCount">0</span> companies
                            <span id="pageInfo" class="float-end">Page 1</span>
                        </div>

                        <!-- Results Container -->
                        <div id="resultsContainer"></div>

                        <!-- Pagination -->
                        <div class="mt-4" id="pagination" style="display: none;">
                            <button class="btn btn-outline-primary page-btn" id="prevPage" disabled>Previous</button>
                            <span class="mx-3">Page <span id="currentPage">1</span></span>
                            <button class="btn btn-outline-primary page-btn" id="nextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <!-- Filters Offcanvas -->
    <div class="offcanvas offcanvas-start bg-body" tabindex="-1" id="offcanvas-menu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-funnel-fill me-2" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                </svg>
                Search Filters
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label class="form-label"><strong>Do they test?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="tests_required" id="tests_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="tests_no">No</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Random tests?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="random_tests" id="random_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="random_no">No</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>After accident?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="after_accident" id="accident_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="accident_no">No</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>During hiring?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="hiring_no">No</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="hiring_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_any" autocomplete="off">
                    <label class="btn btn btn-outline-primary" for="hiring_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Filter by state</strong></label>
                <select class="form-select" id="stateFilter">
                    <option value="">All States</option>
                    <option value="CA">California</option>
                    <option value="TX">Texas</option>
                    <option value="NY">New York</option>
                    <option value="FL">Florida</option>
                    <option value="WA">Washington</option>
                    <option value="IL">Illinois</option>
                    <option value="GA">Georgia</option>
                    <option value="NC">North Carolina</option>
                    <option value="MA">Massachusetts</option>
                    <option value="CO">Colorado</option>
                    <option value="AZ">Arizona</option>
                    <option value="NV">Nevada</option>
                    <option value="OH">Ohio</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="MI">Michigan</option>
                </select>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary w-100 mb-2" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p>Copyright Â© Do They Drug Test? 2025</p>
        </div>
    </footer>

    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    
    <script>
        // API Configuration
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://api.dotheydrugtest.com';
        
        // State management
        let currentPage = 1;
        let currentQuery = '';
        let currentFilters = {};
        let totalResults = 0;
        let hasNextPage = false;
        let page2Preloaded = false;

        // DOM Elements
        const searchInput = document.getElementById('Search-Bar-1');
        const searchButton = document.getElementById('StartSearch');
        const resultsContainer = document.getElementById('resultsContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultsCount = document.getElementById('resultsCount');
        const pageInfo = document.getElementById('pageInfo');
        const pagination = document.getElementById('pagination');
        const currentPageSpan = document.getElementById('currentPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');

        // Initialize from URL parameters
        function initFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            
            if (query) {
                searchInput.value = query;
                currentQuery = query;
                performSearch(1);
            }
        }

        // Perform search with filters
        async function performSearch(page = 1) {
            currentPage = page;
            
            if (!currentQuery && !searchInput.value.trim()) {
                alert('Please enter a search term');
                return;
            }
            
            if (!currentQuery) {
                currentQuery = searchInput.value.trim();
            }
            
            // Build filters object
            const filters = {
                q: currentQuery,
                page: page
            };
            
            // Add boolean filters (only if not "any")
            const testFilter = document.querySelector('input[name="tests_required"]:checked').id;
            if (testFilter === 'tests_yes') filters.tests_required = true;
            else if (testFilter === 'tests_no') filters.tests_required = false;
            
            const randomFilter = document.querySelector('input[name="random_tests"]:checked').id;
            if (randomFilter === 'random_yes') filters.random_tests = true;
            else if (randomFilter === 'random_no') filters.random_tests = false;
            
            const accidentFilter = document.querySelector('input[name="after_accident"]:checked').id;
            if (accidentFilter === 'accident_yes') filters.after_accident = true;
            else if (accidentFilter === 'accident_no') filters.after_accident = false;
            
            const hiringFilter = document.querySelector('input[name="during_hiring"]:checked').id;
            if (hiringFilter === 'hiring_yes') filters.during_hiring = true;
            else if (hiringFilter === 'hiring_no') filters.during_hiring = false;
            
            // Add location filter
            const state = document.getElementById('stateFilter').value;
            if (state) filters.location = state;
            
            currentFilters = filters;
            
            // Show loading
            loadingSpinner.style.display = 'block';
            resultsContainer.innerHTML = '';
            resultsInfo.style.display = 'none';
            pagination.style.display = 'none';
            
            try {
                // Build URL with filters
                const url = new URL(`${API_BASE}/api/search`);
                Object.keys(filters).forEach(key => {
                    if (filters[key] !== undefined && filters[key] !== '') {
                        url.searchParams.append(key, filters[key]);
                    }
                });
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update state
                totalResults = data.total || data.results.length;
                hasNextPage = data.has_next || false;
                
                // Display results
                displayResults(data.results);
                
                // Update UI
                resultsCount.textContent = totalResults;
                pageInfo.textContent = `Page ${page}`;
                currentPageSpan.textContent = page;
                
                // Update pagination buttons
                prevPageBtn.disabled = page === 1;
                nextPageBtn.disabled = !hasNextPage;
                
                // Show UI elements
                resultsInfo.style.display = 'block';
                pagination.style.display = 'flex';
                
                // Preload page 2 if available (your queue requirement)
                if (hasNextPage && !page2Preloaded && page === 1) {
                    preloadPage2();
                }
                
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Search failed:</strong> ${error.message}<br>
                        Try again or check if the API is running.
                    </div>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // Display results
        function displayResults(companies) {
            if (!companies || companies.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        No companies found matching your search criteria.
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="resetFilters()">Reset Filters</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="accordion" id="resultsAccordion">';
            
            companies.forEach((company, index) => {
                const accordionId = `accordion-${index}`;
                const collapseId = `collapse-${index}`;
                
                // Determine badge color based on testing policy
                let badgeColor = 'bg-secondary';
                let badgeText = 'Unknown';
                
                if (company.tests_required === false && company.random_tests === false && 
                    company.after_accident === false && company.during_hiring === false) {
                    badgeColor = 'bg-success';
                    badgeText = 'No Tests';
                } else if (company.tests_required === true || company.random_tests === true) {
                    badgeColor = 'bg-danger';
                    badgeText = 'Tests';
                } else if (company.during_hiring === true) {
                    badgeColor = 'bg-warning';
                    badgeText = 'Hiring Test';
                }
                
                // Build policy description
                const policies = [];
                if (company.tests_required) policies.push('Requires testing');
                if (company.random_tests) policies.push('Random tests');
                if (company.after_accident) policies.push('After accidents');
                if (company.during_hiring) policies.push('During hiring');
                
                const policyText = policies.length > 0 ? policies.join(', ') : 'No testing required';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <strong>${company.name}</strong>
                                <span class="badge ${badgeColor} company-badge">${badgeText}</span>
                                ${company.industry ? `<span class="badge bg-info company-badge">${company.industry}</span>` : ''}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Industry:</strong> ${company.industry || 'Not specified'}</p>
                                        <p><strong>Testing Policy:</strong> ${policyText}</p>
                                        <p><strong>Test Type:</strong> ${company.test_type || 'Not specified'}</p>
                                        <p><strong>Frequency:</strong> ${company.test_frequency || 'Not specified'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Testing Details:</h6>
                                        <ul class="list-unstyled">
                                            <li>Tests Required: <span class="${company.tests_required ? 'test-yes' : 'test-no'}">${company.tests_required ? 'YES' : 'NO'}</span></li>
                                            <li>Random Tests: <span class="${company.random_tests ? 'test-yes' : 'test-no'}">${company.random_tests ? 'YES' : 'NO'}</span></li>
                                            <li>After Accident: <span class="${company.after_accident ? 'test-yes' : 'test-no'}">${company.after_accident ? 'YES' : 'NO'}</span></li>
                                            <li>During Hiring: <span class="${company.during_hiring ? 'test-yes' : 'test-no'}">${company.during_hiring ? 'YES' : 'NO'}</span></li>
                                        </ul>
                                        ${company.states && Array.isArray(company.states) && company.states.length > 0 ? 
                                            `<p><strong>Operates in:</strong> ${company.states.join(', ')}</p>` : ''}
                                    </div>
                                </div>
                                ${company.policy_details ? `<p class="mt-2"><em>${company.policy_details}</em></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        }

        // Preload page 2 (your queue requirement)
        async function preloadPage2() {
            if (page2Preloaded) return;
            
            const preloadFilters = { ...currentFilters, page: 2 };
            const url = new URL(`${API_BASE}/api/search`);
            Object.keys(preloadFilters).forEach(key => {
                if (preloadFilters[key] !== undefined && preloadFilters[key] !== '') {
                    url.searchParams.append(key, preloadFilters[key]);
                }
            });
            
            try {
                // Fetch in background, don't await
                fetch(url).then(response => response.json())
                    .then(data => {
                        console.log('Page 2 preloaded successfully');
                        page2Preloaded = true;
                        // Store in sessionStorage for instant access
                        sessionStorage.setItem('preloadedPage2', JSON.stringify(data));
                    })
                    .catch(error => console.log('Page 2 preload failed:', error));
            } catch (error) {
                // Silent fail - preload is optional
            }
        }

        // Filter functions
        function applyFilters() {
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvas-menu'));
            if (offcanvas) offcanvas.hide();
            performSearch(1);
        }

        function resetFilters() {
            // Reset all radio buttons to "Any"
            document.getElementById('tests_any').checked = true;
            document.getElementById('random_any').checked = true;
            document.getElementById('accident_any').checked = true;
            document.getElementById('hiring_any').checked = true;
            document.getElementById('stateFilter').value = '';
            
            if (currentQuery) {
                performSearch(1);
            }
        }

        // Pagination
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                performSearch(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (hasNextPage) {
                performSearch(currentPage + 1);
            }
        });

        // Search button and enter key
        searchButton.addEventListener('click', () => {
            currentQuery = searchInput.value.trim();
            if (currentQuery) {
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('q', currentQuery);
                window.history.pushState({}, '', url);
                
                performSearch(1);
            }
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentQuery = searchInput.value.trim();
                if (currentQuery) {
                    const url = new URL(window.location);
                    url.searchParams.set('q', currentQuery);
                    window.history.pushState({}, '', url);
                    
                    performSearch(1);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initFromURL();
            
            // Test API connection
            fetch(`${API_BASE}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('api-status').innerHTML = 
                        `<strong>API Connected!</strong> ${data.message}`;
                })
                .catch(error => {
                    document.getElementById('api-status').innerHTML = 
                        `<strong>API Offline</strong> Using fallback data`;
                });
        });
    </script>
</body>
</html>
