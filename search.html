<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2790699901602858" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Search - Do They Drug Test?</title>
    <meta property="og:type" content="website">
    <meta name="description" content="Search for company drug testing policies">
    <meta property="og:image" content="https://dotheydrugtest.com/assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1280" href="assets/img/tubeular.png">
    <link rel="icon" type="image/png" sizes="1280x1197" href="assets/img/Radicaltube.png" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/animate.min.min.css">
    <style>
        .company-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 10px;
        }
        .test-yes { color: #d9534f; font-weight: bold; }
        .test-no { color: #5cb85c; font-weight: bold; }
        .test-sometimes { color: #f0ad4e; font-weight: bold; }
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page-btn {
            margin: 0 5px;
            padding: 5px 15px;
        }
        .results-info {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body id="page-top" data-bs-spy="scroll" data-bs-target="#mainNav" data-bs-offset="77">
    <nav class="navbar navbar-expand-md fixed-top mb-0 pb-0" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">Do They Drug Test?</a>
            <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navbarResponsive" type="button" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" value="Menu" style="padding: 5px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-stack" style="font-size: 21px;">
                    <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.598.598 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535L7.733.063z"></path>
                    <path d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.598.598 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.659z"></path>
                </svg>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item nav-link"></li>
                    <li class="nav-item nav-link"><a class="nav-link" href="/donations.html" style="color: var(--bs-light);">support the cause &lt;3</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="text-center content-section" id="search" style="background: #080808; padding: 100px 0px 20px;">
        <div class="container">
            <!-- Remove the warning alert since site is now working -->
            <div class="alert alert-info beautiful" role="alert" id="api-status">
                <strong>Live Search Active!</strong> Database updated daily with new companies.
            </div>

            <section class="mt-4 pt-0 py-5">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <input class="form-control-lg mb-3" type="search" id="Search-Bar-1" placeholder="Search company names or industries..." autofocus style="background: rgba(163,163,163,0.96); border-radius: 14px; border: 3px solid var(--bs-black); text-align: center;">
                        
                        <div class="d-flex justify-content-center mb-4">
                            <button class="btn btn-primary me-2" id="open-filters" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-menu" style="border-radius: 4px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
                                </svg> Filters
                            </button>
                            <button class="btn btn-success ms-2" id="StartSearch" type="button" style="font-size: 18px; border-radius: 4px;">
                                Search
                            </button>
                        </div>

                        <!-- Loading Spinner -->
                        <div class="loading-spinner" id="loadingSpinner"></div>

                        <!-- Results Info -->
                        <div class="results-info" id="resultsInfo" style="display: none;">
                            Found <span id="resultsCount">0</span> companies
                            <span id="pageInfo" class="float-end">Page 1</span>
                        </div>

                        <!-- Results Container -->
                        <div id="resultsContainer"></div>

                        <!-- Pagination -->
                        <div class="mt-4" id="pagination" style="display: none;">
                            <button class="btn btn-outline-primary page-btn" id="prevPage" disabled>Previous</button>
                            <span class="mx-3">Page <span id="currentPage">1</span></span>
                            <button class="btn btn-outline-primary page-btn" id="nextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <!-- Filters Offcanvas -->
    <div class="offcanvas offcanvas-start bg-body" tabindex="-1" id="offcanvas-menu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-funnel-fill me-2" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                </svg>
                Search Filters
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label class="form-label"><strong>Do they test?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="tests_required" id="tests_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="tests_no">No</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="tests_required" id="tests_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tests_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Random tests?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="random_tests" id="random_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="random_no">No</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="random_tests" id="random_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="random_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>After accident?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="after_accident" id="accident_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="accident_no">No</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="after_accident" id="accident_any" autocomplete="off">
                    <label class="btn btn-outline-primary" for="accident_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>During hiring?</strong></label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_no" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="hiring_no">No</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_yes" autocomplete="off">
                    <label class="btn btn-outline-primary" for="hiring_yes">Yes</label>
                    
                    <input type="radio" class="btn-check" name="during_hiring" id="hiring_any" autocomplete="off">
                    <label class="btn btn btn-outline-primary" for="hiring_any">Any</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Filter by state</strong></label>
                <select class="form-select" id="stateFilter">
                    <option value="">All States</option>
                    <option value="CA">California</option>
                    <option value="TX">Texas</option>
                    <option value="NY">New York</option>
                    <option value="FL">Florida</option>
                    <option value="WA">Washington</option>
                    <option value="IL">Illinois</option>
                    <option value="GA">Georgia</option>
                    <option value="NC">North Carolina</option>
                    <option value="MA">Massachusetts</option>
                    <option value="CO">Colorado</option>
                    <option value="AZ">Arizona</option>
                    <option value="NV">Nevada</option>
                    <option value="OH">Ohio</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="MI">Michigan</option>
                </select>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary w-100 mb-2" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p>Copyright Â© Do They Drug Test? 2025</p>
        </div>
    </footer>

    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    
    // API Configuration
const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:8000' 
    : 'https://api.dotheydrugtest.com';

// State
let currentPage = 1;
let currentQuery = '';
let totalResults = 0;
let hasNextPage = false;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    
    if (query !== null) {
        document.getElementById('Search-Bar-1').value = query;
        currentQuery = query;
        performSearch(1);
    } else {
        performSearch(1);
    }
    
    // Setup event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Search button
    const searchBtn = document.getElementById('StartSearch');
    if (searchBtn) {
        searchBtn.addEventListener('click', function() {
            performSearch(1);
        });
    }
    
    // Search input enter key
    const searchInput = document.getElementById('Search-Bar-1');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch(1);
            }
        });
    }
    
    // Filter buttons
    const filterBtn = document.getElementById('open-filters');
    if (filterBtn) {
        filterBtn.addEventListener('click', function() {
            // Offcanvas will be opened by Bootstrap data attributes
        });
    }
}

async function performSearch(page = 1) {
    currentPage = page;
    currentQuery = document.getElementById('Search-Bar-1').value.trim();
    
    // Build URL
    const url = new URL(`${API_BASE}/api/search`);
    url.searchParams.append('q', currentQuery);
    url.searchParams.append('page', page);
    
    // Get filter values
    const testsFilter = document.querySelector('input[name="tests_required"]:checked');
    const randomFilter = document.querySelector('input[name="random_tests"]:checked');
    const accidentFilter = document.querySelector('input[name="after_accident"]:checked');
    const hiringFilter = document.querySelector('input[name="during_hiring"]:checked');
    const stateSelect = document.getElementById('stateFilter');
    
    if (testsFilter && testsFilter.id !== 'tests_any') {
        url.searchParams.append('tests_required', testsFilter.id === 'tests_yes');
    }
    
    if (randomFilter && randomFilter.id !== 'random_any') {
        url.searchParams.append('random_tests', randomFilter.id === 'random_yes');
    }
    
    if (accidentFilter && accidentFilter.id !== 'accident_any') {
        url.searchParams.append('after_accident', accidentFilter.id === 'accident_yes');
    }
    
    if (hiringFilter && hiringFilter.id !== 'hiring_any') {
        url.searchParams.append('during_hiring', hiringFilter.id === 'hiring_yes');
    }
    
    if (stateSelect && stateSelect.value) {
        url.searchParams.append('location', stateSelect.value);
    }
    
    // Show loading
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        displayResults(data.results, data.grouped_results);
        totalResults = data.total || 0;
        hasNextPage = data.has_next || false;
        
        // Update URL
        if (currentQuery) {
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('q', currentQuery);
            window.history.pushState({}, '', newUrl);
        }
        
    } catch (error) {
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Search failed. Please try again.
                </div>
            `;
        }
    }
}

function displayResults(companies, groupedResults = null) {
    const resultsContainer = document.getElementById('resultsContainer');
    if (!resultsContainer) return;
    
    if (!companies || companies.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-info">
                No companies found matching your criteria.
            </div>
        `;
        return;
    }
    
    let html = '';
    
    if (groupedResults && (groupedResults.exact_matches.length > 0 || groupedResults.industry_matches.length > 0)) {
        // Exact matches
        if (groupedResults.exact_matches.length > 0) {
            html += `
                <div class="mb-4">
                    <h5 class="text-success">Exact Matches</h5>
                    ${createCompaniesList(groupedResults.exact_matches)}
                </div>
            `;
        }
        
        // Industry matches
        if (groupedResults.industry_matches.length > 0) {
            html += `
                <div class="mb-4">
                    <h5 class="text-primary">Related Companies</h5>
                    ${createCompaniesList(groupedResults.industry_matches)}
                </div>
            `;
        }
        
        // Other matches
        if (groupedResults.other_matches && groupedResults.other_matches.length > 0) {
            html += `
                <div class="mb-4">
                    <h5 class="text-secondary">Other Companies</h5>
                    ${createCompaniesList(groupedResults.other_matches)}
                </div>
            `;
        }
        
    } else {
        html = createCompaniesList(companies);
    }
    
    resultsContainer.innerHTML = html;
}

function createCompaniesList(companies) {
    return `
        <div class="list-group">
            ${companies.map(company => `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${company.name}</h6>
                        <small class="text-muted">${company.industry || ''}</small>
                    </div>
                    <div class="mt-2">
                        <span class="badge ${company.tests_required ? 'bg-danger' : 'bg-success'} me-1">
                            ${company.tests_required ? 'Tests Required' : 'No Tests'}
                        </span>
                        ${company.random_tests ? '<span class="badge bg-warning me-1">Random Tests</span>' : ''}
                        ${company.during_hiring ? '<span class="badge bg-info me-1">Hiring Test</span>' : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Make functions available globally
window.performSearch = performSearch;
</body>
</html>
